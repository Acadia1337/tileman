server {
  listen 80;
  server_name tileserver;
  root   /var/www;

  #access_log  /var/log/nginx/tileserver_access.log combined;
  #error_log   /var/log/nginx/tileserver_error.log info;

  include common_location_params;

  location / {
    access_by_lua '
      local osm_tile = require "osm.tile"
      local minz = 0
      local maxz = 18
      local x, y, z = osm_tile.get_cordination(ngx.var.uri, "", "png")
      local ok = osm_tile.check_integrity_xyzm(x, y, z, minz, maxz)
      if not ok then
        ngx.exit(ngx.HTTP_FORBIDDEN)
      end
    ';
    content_by_lua '
      -- required module
      local osm_tile = require "osm.tile"
      local tirex = require "osm.tirex"
      local x, y, z = osm_tile.get_cordination(ngx.var.uri, "", "png")
      -- try renderd file.
      local png, err = osm_tile.get_tile(map, x, y, z)
      if png then
        ngx.header.content_type = "image/png"
        ngx.print(png)
        return ngx.OK
      end
      -- ask tirex to render it
      local ok = tirex.send_request(map, x, y, z)
      if not ok then
         return ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
      end
      local tilefile = osm_tile.xyz_to_metatile_filename(x, y, z)
      local tilepath = "/var/lib/tirex/tiles/custom/"..tilefile
      local png, err = osm_tile.get_tile(tilepath, x, y, z)
      if png then
        ngx.header.content_type = "image/png"
        ngx.print(png)
        return ngx.OK
      end
      return ngx.exit(ngx.HTTP_NOT_FOUND)
    '; 
  }
}
